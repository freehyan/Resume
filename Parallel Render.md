
# 基于多种负载均衡方式的多机并行绘制系统

## 基本概念
* 并行绘制: 分发绘制任务给多台计算机，协同多机的计算能力来提高绘制实时性。
* 负载均衡: 动态调整子任务工作量保证整个系统帧率平稳，达到木桶效应。

## 应用背景

近年来图形学的发展出现以下特点：模型复杂度提高，场景对象更加复杂，绘制真实感要求高，显示分辨率提高，以及真实感和实时性的统一。而这些特点要求更好的计算机硬件处理能力，提高GPU性能与开发分布式并行图形绘制成提高绘制性能的两个方向。 对大规模的场景实时绘制，单GPU计算机的处理能力不能满足需求，**并行绘制**成唯一选择。基于PC集群的分布式并行绘制系统应用于大规模战场仿真，流体仿真与可视化，高性能建模，模拟驾驶，海量高维信息可视化等。

## 关键问题

* 采用什么结构组织集群的图形绘制流水线？
* 如何划分绘制任务？
* 如何同步控制保证所有机器协同完成绘制任务？
* 采用什么方法实现系统的负载均衡？

## 体系结构选取

根据任务划分归属在图形绘制流水线发生的时机将化分集群并行绘制的体系结构归纳为三类：

* sort-first：
	任务划分，负载均衡是难点;
* sort-middle
	需要特定的图形硬件支持；
* sort-lat
	图形传输，合成是瓶颈问题

## 负载均衡策略

负载均衡首要问题是选取有效的负载度量标准完成对场景负载分布的估计(即量化工作负载)，因为负载度量的标准直接影响负载算法的性能。不同体系结构负载均衡需解决问题：

* 如何根据图形应用和场景数据来确定任务划分，分配，调度策略，使得集群各个绘制节点负载大致相当，并保持系统始终处于相对稳定；
* 当负载发生改变时，如何评判系统是否处于均衡状态；而当系统失衡时，如何合理的调整各个绘制服务器之间的负载使得系统重新到达负载均衡状态；
* 如何降低负载均衡算法本身开销，以最小代价达到最佳的均衡性效果;


对sort-first体系而言，任务划分的方式，粒度大小与负载均衡密切相关。总体来说任务划分的粒度越小越容易达到负载均衡，但同时增大了任务划分与负载均衡的计算量。

## 同步控制与容错处理

* 如何保证所有**绘制节点**与**合成节点**协同工作以保证系统正确流畅运行(帧率保持稳定)；
* 交互式实时系统中，系统出现任务堆积与实时交互指令到来情况，如何合理处理堆积任务和实时交互的矛盾，使得系统不仅提高良好的人机交互体验，而且保证画面流畅；
* 节点发生故障时，如何采取容错处理策略使得系统快速从故障中恢复，避免集群中节点故障而造成系统崩溃；

## 绘制结果合成

面对高分辨率显示需求，单一显示屏无法满足应用。需将各个绘制服务器结果进行合成和并分发显示：

	* sort-first: 最终图像的拼接与分割；
	* sort-lat:针对各个绘制节点的绘制结果做基于深度图像合成

如何在现有硬件条件下快速实现绘制结果的合成与分割？

## 网络带宽瓶颈

并行绘制系统运行过程中，场景数据的传输与绘制结果的传输对网络带宽的需求成为并行绘制系统性能的重要因素。
先单以sort-first型绘制结果的传输说明系统网络带宽：
假设系统由五块单屏分辨率为2560*1440的显示器拼接显示，则绘制结果的最终合成的显示分辨率为12800*1440，系统帧率为60FPS，图像格式采用RGBA，则1s内系统传输的数据量采用如下计算：

       12800*1440*4*60Byte = 4423680000Bytes = 4.12GB

对sort-last型带宽更高，负责合成的节点的带宽与绘制服务器的台数成线性关系。

对于TCP/IP体系的千兆以太网还是其他网络设备都是不小的挑战。
如何根据现有的网络硬件设计系统的网络体系结构与数据格式满足系统的带宽需求？


## 实现

## 节点概述

* 控制节点(Control Node): 负责任务的划分，任务的分发调度，绘制结果图片的合成和分割， 
* 绘制节点(Render Node): 负责渲染绘制任务，并把结果返回给控制节点；
* 显示节点(Display Node): 负责显示图片分割结果，从控制节点接收数据；

## 系统流程

* 控制节点根据当前设定绘制节点数量划分场景为相应的子任务，分发各个workload给绘制节点；
* 绘制节点根据workload绘制相应的子任务
* 回传渲染结果给控制节点
* 控制节点同步等待绘制结果并合成一帧图像
* 分割合成图像并根据显示节点数目分发给显示节点
* 显示节点显示最终结果

## 项目难点

* 控制节点须同步等待各个绘制节点渲染结果，这样造成了控制节点的资源浪费；控制节点没法分发下一帧任务，其余绘制节点也处于空闲状态；
* 当绘制结果分辨率很大时，不管是从GPU获取图片到CPU，还是各个子图的合成和分割也是比较耗时；
* 

## 负载均衡

* 统一划分：暴力方式，根据绘制节点数量均分任务，所以每个绘制节点的workload是一样的；
* 时间帧相关性：
* 机器学习：
	* 离线学习:
	* 在线学习:

## 解决方案


## 目前结果



[基于PC集群的分布式并行图形绘制系统的难点](http://www.voidcn.com/blog/hitheu/article/p-3130427.html)